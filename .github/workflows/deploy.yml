name: Deploy Backend

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: List files in root
        run: ls -la

      - name: Unzip backend
        run: |
          if [ -f "backend.zip" ]; then
            unzip -o backend.zip -d ./backend
            if [ -d "./backend/$(ls ./backend | head -1)" ]; then
              mv ./backend/$(ls ./backend | head -1)/* ./backend/
            fi
            ls -la ./backend
          else
            echo "❌ backend.zip not found in root directory!"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          if [ -f "./backend/package.json" ]; then
            cd backend && npm install
          else
            echo "❌ package.json not found in backend folder!"
            exit 1
          fi

      - name: Start server and test
        run: |
          cd backend
          node index.js &
          SERVER_PID=$!
          sleep 10
          if curl -s http://localhost:3001; then
            echo "✅ Server is running on port 3001"
            curl -s https://localhost.run/link http://localhost:3001
          else
            echo "❌ Server failed to start on port 3001"
            kill $SERVER_PID
            exit 1
          fi
